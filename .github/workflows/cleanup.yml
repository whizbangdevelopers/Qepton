name: Cleanup

on:
  # Trigger after release workflow completes
  workflow_run:
    workflows: ["Build and Release"]
    types:
      - completed
  # Manual trigger
  workflow_dispatch:

permissions:
  actions: write
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    # Only run on successful releases (or manual trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Deleting workflow runs older than 14 days (keeping minimum 10 per workflow)..."

          # Get all workflows
          workflows=$(gh api repos/${{ github.repository }}/actions/workflows --paginate -q '.workflows[].id')

          for workflow_id in $workflows; do
            echo "Processing workflow $workflow_id..."

            # Get runs older than 14 days, skip first 10 (keep recent), delete up to 50 per workflow
            gh api "repos/${{ github.repository }}/actions/workflows/$workflow_id/runs?per_page=100" \
              -q '.workflow_runs | sort_by(.created_at) | reverse | .[10:] | .[] | select(.created_at < (now - 14*24*60*60 | strftime("%Y-%m-%dT%H:%M:%SZ"))) | .id' \
              2>/dev/null | head -50 | while read run_id; do
              echo "  Deleting run $run_id"
              gh api -X DELETE "repos/${{ github.repository }}/actions/runs/$run_id" 2>/dev/null || true
            done
          done

          echo "Workflow runs cleanup complete"

      - name: Delete draft releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for draft releases..."
          DRAFTS=$(gh release list --repo ${{ github.repository }} --json tagName,isDraft -q '.[] | select(.isDraft) | .tagName')
          if [ -n "$DRAFTS" ]; then
            echo "Deleting draft releases:"
            echo "$DRAFTS" | while read tag; do
              echo "  - $tag"
              gh release delete "$tag" --repo ${{ github.repository }} --yes 2>/dev/null || true
            done
          else
            echo "No draft releases found"
          fi

      - name: Delete old caches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for old caches..."
          TODAY=$(date -u +%Y-%m-%d)

          # Get all caches and delete those not created today
          gh api repos/${{ github.repository }}/actions/caches --paginate -q '.actions_caches[] | "\(.id) \(.created_at)"' | while read id created_at; do
            CACHE_DATE=$(echo "$created_at" | cut -d'T' -f1)
            if [ "$CACHE_DATE" != "$TODAY" ]; then
              echo "Deleting cache $id (created $CACHE_DATE)"
              gh api -X DELETE repos/${{ github.repository }}/actions/caches/$id 2>/dev/null || true
            fi
          done

          echo "Cache cleanup complete"
