name: Dependabot Tracker

# Auto-updates tracking issue #144 when:
# - package.json changes (dependency merged)
# - Dependabot PRs are opened/closed

on:
  push:
    branches: [main]
    paths: [package.json]
  pull_request:
    types: [opened, closed]
  workflow_dispatch: # Manual trigger for testing

env:
  TRACKING_ISSUE: 144

jobs:
  update-tracker:
    # Only run for Dependabot PRs or package.json changes
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.actor == 'dependabot[bot]')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get current versions and update tracker
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # Get current version from package.json
          get_version() {
            local pkg="$1"
            jq -r --arg p "$pkg" '.dependencies[$p] // .devDependencies[$p] // "n/a"' package.json
          }

          # Parse PR title to extract package and versions
          parse_title() {
            local title="$1"
            local field="$2"

            case "$field" in
              pkg)
                # Handle "bump X from A to B" or "bump X, Y and Z"
                if echo "$title" | grep -q "minor-and-patch"; then
                  echo "(grouped)"
                elif echo "$title" | grep -qE ", .* and "; then
                  echo "(multiple)"
                else
                  echo "$title" | sed -n 's/.*bump \([^ ]*\) from.*/\1/p'
                fi
                ;;
              from)
                echo "$title" | sed -n 's/.*from \([0-9.]*\) to.*/\1/p'
                ;;
              to)
                echo "$title" | sed -n 's/.*to \([0-9.]*\).*/\1/p'
                ;;
            esac
          }

          # Get all open Dependabot PRs
          echo "Fetching Dependabot PRs..."
          PRS=$(gh pr list --author "app/dependabot" --state open --json number,title,createdAt,labels --jq 'sort_by(.createdAt)')

          # Initialize tables
          ready_actions=""
          ready_npm=""
          needs_review=""
          blocked=""

          # Process each PR
          echo "$PRS" | jq -c '.[]' | while IFS= read -r pr; do
            [ -z "$pr" ] && continue

            number=$(echo "$pr" | jq -r '.number')
            title=$(echo "$pr" | jq -r '.title')
            created=$(echo "$pr" | jq -r '.createdAt[:10]')
            labels=$(echo "$pr" | jq -r '[.labels[].name] | join(",")' 2>/dev/null || echo "")

            # Parse package info
            pkg=$(parse_title "$title" "pkg")
            target=$(parse_title "$title" "to")

            # Get current version for npm packages
            if [ -n "$pkg" ] && [ "$pkg" != "(grouped)" ] && [ "$pkg" != "(multiple)" ]; then
              current=$(get_version "$pkg")
            else
              current="various"
              target="mixed"
            fi

            # Determine investigation issue for blocked PRs
            inv="-"
            case "$pkg" in
              vite|@vitejs/*) inv="#140" ;;
              eslint) inv="#141" ;;
              vue-i18n) inv="#142" ;;
              @capacitor/*) inv="#143" ;;
            esac
            # Check title for capacitor in mixed PRs
            if echo "$title" | grep -qi "capacitor"; then
              inv="#143"
            fi

            # Build row and categorize
            if echo "$labels" | grep -q "ready-to-merge"; then
              if echo "$title" | grep -q "chore(actions)"; then
                desc=$(echo "$title" | sed 's/chore(actions): bump //')
                echo "| #$number | $created | $desc |" >> /tmp/ready_actions.txt
              else
                echo "| #$number | $created | $pkg | $current | $target |" >> /tmp/ready_npm.txt
              fi
            elif echo "$labels" | grep -q "blocked-by-quasar"; then
              echo "| #$number | $created | $pkg | $current | $target | $inv |" >> /tmp/blocked.txt
            elif echo "$labels" | grep -q "needs-review"; then
              echo "| #$number | $created | $pkg | $current | $target |" >> /tmp/needs_review.txt
            fi
          done

          # Read results (handle empty files)
          ready_actions=$(cat /tmp/ready_actions.txt 2>/dev/null || echo "")
          ready_npm=$(cat /tmp/ready_npm.txt 2>/dev/null || echo "")
          needs_review=$(cat /tmp/needs_review.txt 2>/dev/null || echo "")
          blocked=$(cat /tmp/blocked.txt 2>/dev/null || echo "")

          # Count PRs
          count_ready_actions=$(echo "$ready_actions" | grep -c '^|' || echo 0)
          count_ready_npm=$(echo "$ready_npm" | grep -c '^|' || echo 0)
          count_ready=$((count_ready_actions + count_ready_npm))
          count_needs=$(echo "$needs_review" | grep -c '^|' || echo 0)
          count_blocked=$(echo "$blocked" | grep -c '^|' || echo 0)

          # Build issue body using heredoc
          cat > /tmp/issue_body.md <<'ISSUE_HEADER'
          ## Overview
          Tracking issue for managing Dependabot PRs. Due to Quasar's dependency constraints, major version upgrades require compatibility verification before merging.

          ## Review Process
          See [CLAUDE.md - Dependabot PRs](./CLAUDE.md#dependabot-prs) and [docs/workflows/REPO-INFRASTRUCTURE.md](docs/workflows/REPO-INFRASTRUCTURE.md#dependabot-pr-review-process) for the full review process.

          ## Labels
          | Label               | Meaning                                       |
          | ------------------- | --------------------------------------------- |
          | `ready-to-merge`    | Reviewed and safe to merge                    |
          | `needs-review`      | Requires manual review                        |
          | `blocked-by-quasar` | Waiting for Quasar/framework compatibility    |

          ISSUE_HEADER

          echo "> **Auto-updated:** $(date -u +'%Y-%m-%d %H:%M UTC') by [dependabot-tracker.yml](.github/workflows/dependabot-tracker.yml)" >> /tmp/issue_body.md
          echo "> Current versions from \`package.json\` on \`main\` branch." >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md
          echo "---" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md

          echo "## ðŸŸ¢ Ready to Merge ($count_ready)" >> /tmp/issue_body.md
          echo "*Sorted by oldest first*" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md
          echo "### GitHub Actions" >> /tmp/issue_body.md
          echo "| PR   | Created    | Description                        |" >> /tmp/issue_body.md
          echo "| ---- | ---------- | ---------------------------------- |" >> /tmp/issue_body.md
          if [ -n "$ready_actions" ]; then
            echo "$ready_actions" >> /tmp/issue_body.md
          else
            echo "| -    | -          | *No GitHub Actions PRs*            |" >> /tmp/issue_body.md
          fi
          echo "" >> /tmp/issue_body.md
          echo "### Minor/Patch Updates" >> /tmp/issue_body.md
          echo "| PR   | Created    | Package              | Current | Target   |" >> /tmp/issue_body.md
          echo "| ---- | ---------- | -------------------- | ------- | -------- |" >> /tmp/issue_body.md
          if [ -n "$ready_npm" ]; then
            echo "$ready_npm" >> /tmp/issue_body.md
          else
            echo "| -    | -          | -                    | -       | -        |" >> /tmp/issue_body.md
          fi
          echo "" >> /tmp/issue_body.md
          echo "---" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md

          echo "## ðŸŸ¡ Needs Review ($count_needs)" >> /tmp/issue_body.md
          echo "*Sorted by oldest first*" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md
          echo "| PR   | Created    | Package              | Current  | Target  |" >> /tmp/issue_body.md
          echo "| ---- | ---------- | -------------------- | -------- | ------- |" >> /tmp/issue_body.md
          if [ -n "$needs_review" ]; then
            echo "$needs_review" >> /tmp/issue_body.md
          else
            echo "| -    | -          | -                    | -        | -       |" >> /tmp/issue_body.md
          fi
          echo "" >> /tmp/issue_body.md
          echo "---" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md

          echo "## ðŸ”´ Blocked by Quasar ($count_blocked)" >> /tmp/issue_body.md
          echo "*Sorted by oldest first*" >> /tmp/issue_body.md
          echo "" >> /tmp/issue_body.md
          echo "| PR   | Created    | Package              | Current  | Target  | Investigation |" >> /tmp/issue_body.md
          echo "| ---- | ---------- | -------------------- | -------- | ------- | ------------- |" >> /tmp/issue_body.md
          if [ -n "$blocked" ]; then
            echo "$blocked" >> /tmp/issue_body.md
          else
            echo "| -    | -          | -                    | -        | -       | -             |" >> /tmp/issue_body.md
          fi
          echo "" >> /tmp/issue_body.md

          cat >> /tmp/issue_body.md <<'ISSUE_FOOTER'
          ### Sub-issues for Investigation
          - [ ] #140 - Vite 5 â†’ 7
          - [ ] #141 - ESLint 8 â†’ 9
          - [ ] #142 - vue-i18n 9 â†’ 11
          - [ ] #143 - Capacitor 5 â†’ 8

          ---

          ## Automation
          - **Labeling:** [dependabot-labeler.yml](.github/workflows/dependabot-labeler.yml) auto-labels new PRs
          - **Tracking:** [dependabot-tracker.yml](.github/workflows/dependabot-tracker.yml) auto-updates this issue
          ISSUE_FOOTER

          # Update the tracking issue
          gh issue edit $TRACKING_ISSUE --body-file /tmp/issue_body.md
          echo "âœ… Updated tracking issue #$TRACKING_ISSUE"
