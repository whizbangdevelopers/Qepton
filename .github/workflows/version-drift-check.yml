name: Version Constraint Drift Check

# Detects when package.json constraints drift from installed versions
# Creates a PR to align constraints with actual installed minor versions

on:
  schedule:
    - cron: '0 10 * * 1' # Monday 10:00 UTC (after Dependabot at 9:00)
  workflow_dispatch: # Manual trigger

jobs:
  check-drift:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for version drift
        id: drift
        run: |
          set -e

          echo "Checking for version constraint drift..."
          echo ""

          DRIFT_FOUND=false
          DRIFT_LIST=""
          UPDATES=""

          # Function to extract major.minor from version string
          get_major_minor() {
            echo "$1" | sed 's/[\^~>=<]//g' | cut -d. -f1,2
          }

          # Get all dependencies from package.json
          DEPS=$(jq -r '(.dependencies // {}) + (.devDependencies // {}) | to_entries[] | "\(.key)|\(.value)"' package.json)

          while IFS='|' read -r pkg constraint; do
            [ -z "$pkg" ] && continue

            # Skip packages without standard semver constraints
            if ! echo "$constraint" | grep -qE '^\^[0-9]+\.[0-9]+'; then
              continue
            fi

            # Get installed version from package-lock.json
            installed=$(jq -r --arg p "node_modules/$pkg" '.packages[$p].version // empty' package-lock.json)
            [ -z "$installed" ] && continue

            # Compare major.minor
            constraint_mm=$(get_major_minor "$constraint")
            installed_mm=$(get_major_minor "$installed")

            if [ "$constraint_mm" != "$installed_mm" ]; then
              DRIFT_FOUND=true
              DRIFT_LIST="${DRIFT_LIST}| \`$pkg\` | \`$constraint\` | \`$installed\` | \`^${installed_mm}.0\` |\n"
              UPDATES="${UPDATES}$pkg|$constraint|^${installed_mm}.0\n"
              echo "DRIFT: $pkg - constraint $constraint vs installed $installed"
            fi
          done <<< "$DEPS"

          echo ""
          echo "drift_found=$DRIFT_FOUND" >> $GITHUB_OUTPUT

          # Save drift list for PR body
          echo "drift_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DRIFT_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Save updates for processing
          echo -e "$UPDATES" > /tmp/updates.txt

          if [ "$DRIFT_FOUND" = "true" ]; then
            echo "✅ Drift detected - will create PR"
          else
            echo "✅ No drift detected"
          fi

      - name: Update package.json
        if: steps.drift.outputs.drift_found == 'true'
        run: |
          while IFS='|' read -r pkg old_constraint new_constraint; do
            [ -z "$pkg" ] && continue
            echo "Updating $pkg: $old_constraint → $new_constraint"

            # Use jq to update the version in place
            if jq -e --arg p "$pkg" '.dependencies[$p]' package.json > /dev/null 2>&1; then
              jq --arg p "$pkg" --arg v "$new_constraint" '.dependencies[$p] = $v' package.json > package.json.tmp
              mv package.json.tmp package.json
            elif jq -e --arg p "$pkg" '.devDependencies[$p]' package.json > /dev/null 2>&1; then
              jq --arg p "$pkg" --arg v "$new_constraint" '.devDependencies[$p] = $v' package.json > package.json.tmp
              mv package.json.tmp package.json
            fi
          done < /tmp/updates.txt

      - name: Create Pull Request
        if: steps.drift.outputs.drift_found == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.SYNC_TOKEN }}  # PAT required - GITHUB_TOKEN can't create PRs
          commit-message: "chore(deps): align package.json constraints with installed versions"
          title: "chore(deps): align package.json constraints with installed versions"
          body: |
            ## Version Constraint Drift Detected

            The following packages have `package.json` constraints that don't match the installed minor versions:

            | Package | Current Constraint | Installed | Suggested |
            | ------- | ------------------ | --------- | --------- |
            ${{ steps.drift.outputs.drift_list }}

            This PR updates constraints to `^x.y.0` format matching installed versions.

            ### Why this matters
            - Documents actual minimum versions being used
            - Prevents confusion about project requirements
            - No functional changes - just constraint alignment

            ---
            *Auto-generated by [version-drift-check.yml](.github/workflows/version-drift-check.yml)*
          branch: chore/version-constraint-drift
          delete-branch: true
          labels: |
            dependencies
            automated
