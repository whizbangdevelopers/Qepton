name: Quasar Compatibility Check

# Checks if blocked Dependabot PRs are now compatible with Quasar
# Runs weekly and on manual trigger

on:
  schedule:
    - cron: '0 9 * * 1' # Monday 9:00 UTC
  workflow_dispatch: # Manual trigger

env:
  TRACKING_ISSUE: 144

jobs:
  check-compatibility:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Quasar ecosystem compatibility
        id: compat
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          echo "Fetching Quasar package info from npm..."

          # Get @quasar/app-vite dependencies
          APP_VITE=$(curl -s "https://registry.npmjs.org/@quasar/app-vite/latest")
          APP_VITE_VERSION=$(echo "$APP_VITE" | jq -r '.version')
          VITE_DEP=$(echo "$APP_VITE" | jq -r '.dependencies.vite // "unknown"')

          # Get @quasar/vite-plugin peer dependencies
          VITE_PLUGIN=$(curl -s "https://registry.npmjs.org/@quasar/vite-plugin/latest")
          VITE_PLUGIN_VERSION=$(echo "$VITE_PLUGIN" | jq -r '.version')
          VITE_PEER=$(echo "$VITE_PLUGIN" | jq -r '.peerDependencies.vite // "unknown"')

          # Get eslint-plugin-vue (used by Quasar projects)
          ESLINT_VUE=$(curl -s "https://registry.npmjs.org/eslint-plugin-vue/latest")
          ESLINT_VUE_VERSION=$(echo "$ESLINT_VUE" | jq -r '.version')
          ESLINT_PEER=$(echo "$ESLINT_VUE" | jq -r '.peerDependencies.eslint // "unknown"')

          echo "=== Quasar Ecosystem Versions ==="
          echo "@quasar/app-vite: $APP_VITE_VERSION (vite: $VITE_DEP)"
          echo "@quasar/vite-plugin: $VITE_PLUGIN_VERSION (vite peer: $VITE_PEER)"
          echo "eslint-plugin-vue: $ESLINT_VUE_VERSION (eslint peer: $ESLINT_PEER)"

          # Get our current versions
          OUR_QUASAR_APP_VITE=$(jq -r '.devDependencies["@quasar/app-vite"] // "unknown"' package.json)
          echo ""
          echo "=== Our Versions ==="
          echo "@quasar/app-vite: $OUR_QUASAR_APP_VITE"

          # Check blocked PRs
          UPDATES=""
          RELABEL_PRS=""

          # Check Vite compatibility (PR #130)
          # Parse major version from dependency string like "^7.0.3"
          if echo "$VITE_DEP" | grep -qE '\^7\.'; then
            echo ""
            echo "âœ… Vite 7 is supported by @quasar/app-vite@$APP_VITE_VERSION"
            UPDATES="${UPDATES}\n- âœ… **Vite 7** is now supported by \`@quasar/app-vite@$APP_VITE_VERSION\` (uses \`vite: $VITE_DEP\`). PR #130 may be ready to merge."
            RELABEL_PRS="${RELABEL_PRS}130 "
          fi

          # Check ESLint compatibility (PR #128)
          # eslint-plugin-vue 9.x supports ESLint 8 and 9
          if echo "$ESLINT_PEER" | grep -qE '9'; then
            echo ""
            echo "âœ… ESLint 9 is supported by eslint-plugin-vue@$ESLINT_VUE_VERSION"
            UPDATES="${UPDATES}\n- âœ… **ESLint 9** is supported by \`eslint-plugin-vue@$ESLINT_VUE_VERSION\` (peer: \`$ESLINT_PEER\`). PR #128 may need testing - ESLint 9 requires flat config migration."
            # Don't auto-relabel ESLint - needs manual migration work
          fi

          # Save outputs
          echo "updates<<EOF" >> $GITHUB_OUTPUT
          echo -e "$UPDATES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "relabel_prs=$RELABEL_PRS" >> $GITHUB_OUTPUT
          echo "app_vite_version=$APP_VITE_VERSION" >> $GITHUB_OUTPUT

      - name: Comment on tracking issue if updates found
        if: steps.compat.outputs.updates != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT="## ðŸ” Quasar Compatibility Check - $(date -u +'%Y-%m-%d')

          The weekly compatibility check found potential updates:
          ${{ steps.compat.outputs.updates }}

          ### Next Steps
          1. Review the affected PRs
          2. Test the upgrade in a branch
          3. Update labels if ready to merge

          ---
          *Auto-generated by [quasar-compat-check.yml](.github/workflows/quasar-compat-check.yml)*"

          gh issue comment $TRACKING_ISSUE --body "$COMMENT"
          echo "âœ… Posted comment to issue #$TRACKING_ISSUE"

      - name: Update PR labels (Vite only - safe to auto-update)
        if: contains(steps.compat.outputs.relabel_prs, '130')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Updating PR #130 labels..."
          gh pr edit 130 --remove-label "blocked-by-quasar" --add-label "needs-review" || true
          echo "âœ… Updated PR #130 labels"

      - name: Summary
        run: |
          echo "## Quasar Compatibility Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**@quasar/app-vite version:** ${{ steps.compat.outputs.app_vite_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.compat.outputs.updates }}" ]; then
            echo "### Updates Found" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.compat.outputs.updates }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "No compatibility changes detected." >> $GITHUB_STEP_SUMMARY
          fi
